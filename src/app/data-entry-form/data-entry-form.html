@if (loading()) {
  <div class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>
}

<form [formGroup]="entryForm" (ngSubmit)="onSubmit()" class="data-entry-form" novalidate>
  <h2>{{ isEditMode() ? 'Daten bearbeiten' : 'Neuen Dateneintrag erstellen' }}</h2>

  <div class="form-section">
    <mat-form-field appearance="fill">
      <mat-label>Station</mat-label>
      <input matInput formControlName="ringing_station">
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Beringer</mat-label>
      <input matInput type="number" formControlName="staff">
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Datum und Uhrzeit</mat-label>
      <input matInput type="datetime-local" formControlName="date_time">
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Art</mat-label>
      <input type="text" matInput formControlName="species" [matAutocomplete]="auto">
      <mat-autocomplete #auto="matAutocomplete" [displayWith]="displaySpecies">
        @for (option of filteredSpecies | async; track option.id) {
          <mat-option [value]="option">{{ option.common_name_de }} ({{ option.scientific_name }})</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>
  </div>

  <div class="form-section">
    <mat-form-field appearance="fill">
      <mat-label>Status</mat-label>
      <mat-select formControlName="bird_status" (selectionChange)="onBirdStatusChange($event.value)">
        @for (option of birdStatusOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Ringnummer</mat-label>
      <input matInput formControlName="ring_number" #ringNumberInput>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Netznr.</mat-label>
      <input matInput type="number" formControlName="net_location" #netLocationInput>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Netzfach</mat-label>
      <input matInput type="number" formControlName="net_height">
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Flugrichtung</mat-label>
      <mat-select formControlName="net_direction" (selectionChange)="onNetDirectionChange($event.value)">
        <mat-option value="L">Links (L)</mat-option>
        <mat-option value="R">Rechts (R)</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="biometrics-section">
    <div class="column">
      <mat-form-field appearance="fill">
        <mat-label>Fett</mat-label>
        <input matInput type="number" formControlName="fat_deposit">
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Tarsus (mm)</mat-label>
        <input matInput type="number" formControlName="tarsus">
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Federl. (mm)</mat-label>
        <input matInput type="number" formControlName="feather_span">
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Flügell. (mm)</mat-label>
        <input matInput type="number" formControlName="wing_span">
      </mat-form-field>
    </div>
    <div class="column">
      <mat-form-field appearance="fill">
        <mat-label>Gewicht (g)</mat-label>
        <input matInput type="number" formControlName="weight_gram">
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Kerbe F2 (mm)</mat-label>
        <input matInput type="number" formControlName="notch_f2">
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Innenfuß (mm)</mat-label>
        <input matInput type="number" formControlName="inner_foot">
      </mat-form-field>
    </div>
  </div>

  <div class="form-section">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Bemerkungen</mat-label>
      <textarea matInput formControlName="comment" rows="3"></textarea>
    </mat-form-field>
  </div>

  <div class="action-buttons">
    <button mat-stroked-button type="button" routerLink="/">Abbrechen</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="entryForm.invalid || loading()">
      {{ isEditMode() ? 'Speichern' : 'Erstellen' }}
    </button>
  </div>
</form>
