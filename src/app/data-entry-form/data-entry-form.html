@if (loading()) {
  <div class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>
}

<div class="container-fluid p-0 m-0 mx-auto" style="max-width: 1200px;">
  @if (recaptureHistory().length > 0) {
    <div class="recapture-section">
      <h3>Bisherige Fänge</h3>
      <table mat-table [dataSource]="recaptureHistory()" class="mat-elevation-z2">

        <ng-container matColumnDef="date_time">
          <th mat-header-cell *matHeaderCellDef> Datum</th>
          <td mat-cell *matCellDef="let element"> {{ element.date_time | date:'dd.MM.yyyy HH:mm' }}</td>
        </ng-container>

        <ng-container matColumnDef="ringing_station">
          <th mat-header-cell *matHeaderCellDef> Station</th>
          <td mat-cell *matCellDef="let element"> {{ element.ringing_station.name }}</td>
        </ng-container>

        <ng-container matColumnDef="staff">
          <th mat-header-cell *matHeaderCellDef> Beringer</th>
          <td mat-cell *matCellDef="let element"> {{ element.staff.full_name }}</td>
        </ng-container>

        <ng-container matColumnDef="wing_span">
          <th mat-header-cell *matHeaderCellDef> Flügel (mm)</th>
          <td mat-cell *matCellDef="let element"> {{ element.wing_span }}</td>
        </ng-container>

        <ng-container matColumnDef="weight_gram">
          <th mat-header-cell *matHeaderCellDef> Gewicht (g)</th>
          <td mat-cell *matCellDef="let element"> {{ element.weight_gram }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedHistoryColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedHistoryColumns;"></tr>
      </table>
    </div>
  }

  <form [formGroup]="entryForm" (ngSubmit)="onSubmit()" class="data-entry-form" novalidate>
    <h2>{{ isEditMode() ? 'Daten bearbeiten' : 'Neuen Dateneintrag erstellen' }}</h2>

    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Zentrale</mat-label>
        <input type="text" matInput formControlName="organization">
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Station</mat-label>
        <input type="text" matInput formControlName="ringing_station" [matAutocomplete]="stationAuto">
        <mat-autocomplete #stationAuto="matAutocomplete" [displayWith]="displayStation">
          @for (option of filteredStations | async; track option.handle) {
            <mat-option [value]="option">{{ option.name }}</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Beringer</mat-label>
        <input type="text" matInput formControlName="staff" [matAutocomplete]="staffAuto">
        <mat-autocomplete #staffAuto="matAutocomplete" [displayWith]="displayScientist">
          @for (option of filteredScientists | async; track option.id) {
            <mat-option [value]="option">{{ option.full_name }} ({{ option.handle }})</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Datum und Uhrzeit</mat-label>
        <input matInput type="datetime-local" formControlName="date_time">
      </mat-form-field>
    </div>

    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Art</mat-label>
        <input
          type="text"
          matInput
          formControlName="species"
          [matAutocomplete]="auto" selectOnTab>
        <mat-autocomplete
          #auto="matAutocomplete"
          [displayWith]="displaySpecies"
          (optionSelected)="onSpeciesSelected($event)"
          [autoActiveFirstOption]="true">
          @for (option of filteredSpecies | async; track option.id) {
            <mat-option [value]="option">{{ option.common_name_de }} ({{ option.scientific_name }})</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Status</mat-label>
        <mat-select formControlName="bird_status" #statusSelect
                    (keydown)="onSelectKeydown($event, 'bird_status', birdStatusOptions, statusSelect)">
          @for (option of birdStatusOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Ringgröße</mat-label>
        <mat-select
          #ringSizeSelect
          formControlName="ring_size"
          (keydown)="onSelectKeydown($event, 'ring_size', ringSizeOptions, ringSizeSelect)">
          @for (option of ringSizeOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Ringnummer</mat-label>
        <input matInput formControlName="ring_number" pattern="[0-9]*" inputmode="numeric">
      </mat-form-field>

      @if (isRecatch()) {
        <button mat-icon-button type="button" (click)="fetchRingHistory()"
                [disabled]="!entryForm.get('ring_size')?.value || !entryForm.get('ring_number')?.value"
                aria-label="Find ring history">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
               fill="currentColor">
            <path
              d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
          </svg>
        </button>
      }
    </div>

    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Netznummer</mat-label>
        <input matInput type="number" formControlName="net_location">
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Netzfach</mat-label>
        <input matInput type="number" formControlName="net_height">
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Flugrichtung</mat-label>
        <mat-select formControlName="net_direction" #directionSelect
                    (keydown)="onSelectKeydown($event, 'net_direction', directionOptions, directionSelect)">
          @for (option of directionOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Alter</mat-label>
        <mat-select formControlName="age_class" #ageClassSelect
                    (keydown)="onSelectKeydown($event, 'age_class', ageClassOptions, ageClassSelect)">
          @for (option of ageClassOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Geschlecht</mat-label>
        <mat-select formControlName="sex" #sexSelect
                    (keydown)="onSelectKeydown($event, 'sex', sexOptions, sexSelect)">
          @for (option of sexOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Fett</mat-label>
        <mat-select formControlName="fat_deposit" #fatClassSelect
                    (keydown)="onSelectKeydown($event, 'fat_deposit', fatClassOptions, fatClassSelect)">
          @for (option of fatClassOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Muskelklasse</mat-label>
        <mat-select formControlName="muscle_class" #muscleClassSelect
                    (keydown)="onSelectKeydown($event, 'muscle_class', muscleClassOptions, muscleClassSelect)">
          @for (option of muscleClassOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Kleingefieder Intensität</mat-label>
        <mat-select formControlName="small_feather_int" #smallFeatherIntSelect
                    (keydown)="onSelectKeydown($event, 'small_feather_int', smallFeatherIntOptions, smallFeatherIntSelect)">
          @for (option of smallFeatherIntOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Kleingefieder Fortschritt</mat-label>
        <mat-select formControlName="small_feather_app" #smallFeatherAppSelect
                    (keydown)="onSelectKeydown($event, 'small_feather_app', smallFeatherAppOptions, smallFeatherAppSelect)">
          @for (option of smallFeatherAppOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Handschwingenmauser</mat-label>
        <mat-select formControlName="hand_wing" #handWingSelect
                    (keydown)="onSelectKeydown($event, 'hand_wing', handWingMoultOptions, handWingSelect)">
          @for (option of handWingMoultOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Tarsus (mm)</mat-label>
        <input matInput type="number" formControlName="tarsus">
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Federlänge (mm)</mat-label>
        <input matInput type="number" formControlName="feather_span">
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Flügellänge (mm)</mat-label>
        <input matInput type="number" formControlName="wing_span">
      </mat-form-field>
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Gewicht (g)</mat-label>
        <input matInput type="number" formControlName="weight_gram">
      </mat-form-field>
    </div>
    <div class="form-section-checkboxes">
      <mat-checkbox formControlName="has_mites">Milben</mat-checkbox>
      <mat-checkbox formControlName="has_hunger_stripes">Hungerstreifen</mat-checkbox>
      <mat-checkbox formControlName="has_brood_patch">Brutfleck</mat-checkbox>
      <mat-checkbox formControlName="has_cpl_plus">CPL+</mat-checkbox>
    </div>
    <div class="form-section">
      <mat-form-field appearance="outline" floatLabel="always" class="full-width">
        <mat-label>Bemerkungen</mat-label>
        <textarea matInput formControlName="comment" rows="3"></textarea>
      </mat-form-field>
    </div>

    <div class="biometrics-section">
      <div class="column">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Kerbe F2 (mm)</mat-label>
          <input matInput type="number" formControlName="notch_f2">
        </mat-form-field>
      </div>
      <div class="column">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Innenfuß (mm)</mat-label>
          <input matInput type="number" formControlName="inner_foot">
        </mat-form-field>
      </div>
    </div>

    <div class="action-buttons">
      <button mat-stroked-button type="button" routerLink="/">Abbrechen</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="entryForm.invalid || loading()">
        {{ isEditMode() ? 'Speichern' : 'Erstellen' }}
      </button>
    </div>
  </form>
</div>
